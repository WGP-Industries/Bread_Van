{% extends "layout.html" %}
{% block title %}My Drives - Bread Van{% endblock %}

{% block content %}
<div class="row">
    <div class="col s12">
        <h4>My Drives</h4>
        <div class="divider"></div>
        
        <!-- Quick Actions -->
        <div class="row" style="margin-bottom: 20px;">
            <div class="col s12">
                <a href="/driver/drives/schedule" class="btn blue waves-effect waves-light">
                    <i class="material-icons left">add_circle</i>Schedule New Drive
                </a>
                <a href="/driver/dashboard" class="btn grey waves-effect waves-light">
                    <i class="material-icons left">dashboard</i>Back to Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Tabs for different drive statuses -->
<div class="row">
    <div class="col s12">
        <ul class="tabs">
            <li class="tab col s3"><a href="#upcoming" class="active">Upcoming ({{ upcoming_drives|length }})</a></li>
            <li class="tab col s3"><a href="#in-progress">In Progress ({{ in_progress_drives|length }})</a></li>
            <li class="tab col s3"><a href="#completed">Completed ({{ completed_drives|length }})</a></li>
            <li class="tab col s3"><a href="#cancelled">Cancelled ({{ cancelled_drives|length }})</a></li>
        </ul>
    </div>
</div>

<!-- Upcoming Drives Tab -->
<div id="upcoming" class="col s12">
    {% if upcoming_drives %}
    <div class="row">
        {% for drive in upcoming_drives %}
        <div class="col s12 m6 l4">
            <div class="card blue-grey lighten-5">
                <div class="card-content">
                    <span class="card-title">
                        Drive #{{ drive.id }}
                        <span class="badge blue white-text">{{ drive.status }}</span>
                    </span>
                    
                    <div class="drive-info">
                        <p><strong>Date:</strong> {{ drive.date }}</p>
                        <p><strong>Time:</strong> {{ drive.time }}</p>
                        <p><strong>Location:</strong> {{ drive.area.name }}, {{ drive.street.name }}</p>
                        {% if drive.eta %}
                        <p><strong>ETA:</strong> {{ drive.eta }}</p>
                        {% endif %}
                        {% if drive.menu %}
                        <p><strong>Menu:</strong> {{ drive.menu|truncate(50) }}</p>
                        {% endif %}
                    </div>
                </div>
                <div class="card-action">
                    <a href="/driver/drives/{{ drive.id }}" class="blue-text">
                        <i class="material-icons tiny">visibility</i> View Details
                    </a>
                    <a href="/driver/drives/{{ drive.id }}/start" class="green-text">
                        <i class="material-icons tiny">play_arrow</i> Start
                    </a>
                    <a href="/driver/drives/{{ drive.id }}/cancel" class="red-text">
                        <i class="material-icons tiny">cancel</i> Cancel
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="center" style="padding: 40px;">
        <i class="material-icons large grey-text">schedule</i>
        <h5>No Upcoming Drives</h5>
        <p>You haven't scheduled any drives yet.</p>
        <a href="/driver/drives/schedule" class="btn blue">Schedule Your First Drive</a>
    </div>
    {% endif %}
</div>

<!-- In Progress Drives Tab -->
<div id="in-progress" class="col s12">
    {% if in_progress_drives %}
    <div class="row">
        {% for drive in in_progress_drives %}
        <div class="col s12 m6 l4">
            <div class="card orange lighten-5">
                <div class="card-content">
                    <span class="card-title">
                        Drive #{{ drive.id }}
                        <span class="badge orange white-text">{{ drive.status }}</span>
                    </span>
                    
                    <div class="drive-info">
                        <p><strong>Date:</strong> {{ drive.date }}</p>
                        <p><strong>Started:</strong> {{ drive.time }}</p>
                        <p><strong>Location:</strong> {{ drive.area.name }}, {{ drive.street.name }}</p>
                        {% if drive.eta %}
                        <p><strong>ETA:</strong> {{ drive.eta }}</p>
                        {% endif %}
                    </div>
                    
                    <!-- Quick Stop Actions -->
                    <div class="row" style="margin-top: 15px;">
                        <div class="col s12">
                            <a href="/driver/drives/{{ drive.id }}/requested-stops" class="btn-small amber">
                                <i class="material-icons left">list</i> View Stops ({{ drive.stops|length }})
                            </a>
                        </div>
                    </div>
                </div>
                <div class="card-action">
                    <a href="/driver/drives/{{ drive.id }}" class="blue-text">
                        <i class="material-icons tiny">visibility</i> Details
                    </a>
                    <a href="/driver/drives/{{ drive.id }}/end" class="red-text">
                        <i class="material-icons tiny">stop</i> End Drive
                    </a>
                    <a href="/map?drive={{ drive.id }}" class="green-text">
                        <i class="material-icons tiny">location_on</i> Live Map
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="center" style="padding: 40px;">
        <i class="material-icons large orange-text">directions_car</i>
        <h5>No Drives in Progress</h5>
        <p>You don't have any active drives right now.</p>
    </div>
    {% endif %}
</div>

<!-- Completed Drives Tab -->
<div id="completed" class="col s12">
    {% if completed_drives %}
    <div class="row">
        {% for drive in completed_drives %}
        <div class="col s12 m6 l4">
            <div class="card green lighten-5">
                <div class="card-content">
                    <span class="card-title">
                        Drive #{{ drive.id }}
                        <span class="badge green white-text">{{ drive.status }}</span>
                    </span>
                    
                    <div class="drive-info">
                        <p><strong>Date:</strong> {{ drive.date }}</p>
                        <p><strong>Time:</strong> {{ drive.time }}</p>
                        <p><strong>Location:</strong> {{ drive.area.name }}, {{ drive.street.name }}</p>
                        <p><strong>Stops Completed:</strong> {{ drive.stops|length }}</p>
                    </div>
                </div>
                <div class="card-action">
                    <a href="/driver/drives/{{ drive.id }}" class="blue-text">
                        <i class="material-icons tiny">summarize</i> View Summary
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="center" style="padding: 40px;">
        <i class="material-icons large green-text">check_circle</i>
        <h5>No Completed Drives</h5>
        <p>You haven't completed any drives yet.</p>
    </div>
    {% endif %}
</div>

<!-- Cancelled Drives Tab -->
<div id="cancelled" class="col s12">
    {% if cancelled_drives %}
    <div class="row">
        {% for drive in cancelled_drives %}
        <div class="col s12 m6 l4">
            <div class="card red lighten-5">
                <div class="card-content">
                    <span class="card-title">
                        Drive #{{ drive.id }}
                        <span class="badge red white-text">{{ drive.status }}</span>
                    </span>
                    
                    <div class="drive-info">
                        <p><strong>Date:</strong> {{ drive.date }}</p>
                        <p><strong>Time:</strong> {{ drive.time }}</p>
                        <p><strong>Location:</strong> {{ drive.area.name }}, {{ drive.street.name }}</p>
                    </div>
                </div>
                <div class="card-action">
                    <span class="grey-text">Cancelled</span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="center" style="padding: 40px;">
        <i class="material-icons large grey-text">cancel</i>
        <h5>No Cancelled Drives</h5>
        <p>Great! You haven't cancelled any drives.</p>
    </div>
    {% endif %}
</div>

<!-- Alternative: Table View (Toggle) -->
<div class="row" style="margin-top: 30px;">
    <div class="col s12">
        <div class="card">
            <div class="card-content">
                <span class="card-title">All Drives - Table View</span>
                
                <table class="highlight responsive-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Area</th>
                            <th>Street</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for drive in upcoming_drives %}
                        <tr>
                            <td>#{{ drive.id }}</td>
                            <td>{{ drive.date }}</td>
                            <td>{{ drive.time }}</td>
                            <td>{{ drive.area.name }}</td>
                            <td>{{ drive.street.name }}</td>
                            <td><span class="badge blue white-text">{{ drive.status }}</span></td>
                            <td>
                                <a href="/driver/drives/{{ drive.id }}" class="btn-small blue">View</a>
                                <a href="/driver/drives/{{ drive.id }}/start" class="btn-small green">Start</a>
                            </td>
                        </tr>
                        {% endfor %}
                        
                        {% for drive in in_progress_drives %}
                        <tr>
                            <td>#{{ drive.id }}</td>
                            <td>{{ drive.date }}</td>
                            <td>{{ drive.time }}</td>
                            <td>{{ drive.area.name }}</td>
                            <td>{{ drive.street.name }}</td>
                            <td><span class="badge orange white-text">{{ drive.status }}</span></td>
                            <td>
                                <a href="/driver/drives/{{ drive.id }}" class="btn-small blue">View</a>
                                <a href="/driver/drives/{{ drive.id }}/end" class="btn-small red">End</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize tabs
        var tabs = document.querySelectorAll('.tabs');
        M.Tabs.init(tabs);
        
        // Initialize tooltips
        var tooltips = document.querySelectorAll('.tooltipped');
        M.Tooltip.init(tooltips);
        
        // Confirm before cancelling a drive
        document.addEventListener('click', function(e) {
            if (e.target.closest('a[href*="/cancel"]')) {
                e.preventDefault();
                var url = e.target.closest('a').href;
                if (confirm('Are you sure you want to cancel this drive?')) {
                    window.location.href = url;
                }
            }
            
            if (e.target.closest('a[href*="/end"]')) {
                e.preventDefault();
                var url = e.target.closest('a').href;
                if (confirm('Are you sure you want to end this drive?')) {
                    window.location.href = url;
                }
            }
        });
        
        // Update active drive status every 30 seconds
        function updateDriveStatus() {
            fetch('/driver/drives/status', {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                }
            })
            .then(response => response.json())
            .then(data => {
                // Update status badges if needed
                console.log('Drive status updated');
            })
            .catch(err => console.log('Error updating status:', err));
        }
        
        // Update every 30 seconds if on in-progress tab
        setInterval(function() {
            if (window.location.hash === '#in-progress') {
                updateDriveStatus();
            }
        }, 30000);
    });
</script>

<style>
    .drive-info {
        margin: 10px 0;
        padding: 10px;
        background-color: rgba(255, 255, 255, 0.7);
        border-radius: 5px;
    }
    
    .drive-info p {
        margin: 5px 0;
        font-size: 14px;
    }
    
    .badge {
        padding: 3px 8px;
        border-radius: 10px;
        font-size: 12px;
        float: right;
    }
    
    .card-title {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .card-action a {
        margin-right: 10px;
    }
    
    .tabs .tab a {
        color: #8d6e63;
    }
    
    .tabs .tab a.active {
        color: #5d4037;
    }
    
    .tabs .indicator {
        background-color: #8d6e63;
    }
</style>
{% endblock %}